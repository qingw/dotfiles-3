#!/bin/bash -e

cd "$HOME"

run() {
    echo "start running $@ at $(pwd)" >&2
    if ! "$@"; then
        echo "run $@ failed!" >&2
    fi
}

update_context() {
    echo "updating ConTeXt"
    _POSSIBLE_PATH="/Volumes/DATA/ConTeXt /Volumes/MacData/ConTeXt /Volumes/SteamedFish/ConTeXt $HOME/ConTeXt"
    for _CONTEXT_PATH in ${_POSSIBLE_PATH}; do
        if [ -d "${_CONTEXT_PATH}" ]; then
            cd "${_CONTEXT_PATH}"
            run rsync -av rsync://contextgarden.net/minimals/setup/first-setup.sh .
            run bash first-setup.sh --modules=all
        fi
    done
    run mtxrun --scripts fonts --reload
    unset _POSSIBLE_PATH
    unset _CONTEXT_PATH
}

update_mac_system() {
    if [[ "$(kextstat | grep "FakeSMC")" == "" ]]; then
        echo "updating system"
        run sudo softwareupdate -i -a
    fi
}

update_linux_system() {
    if  [[ -f /etc/arch-release ]]; then
        run yay -Syu
    elif [[ -f /etc/debian_version ]]; then
        run sudo apt update
        run sudo apt upgrade
    elif [[ $(uname -o) == "Android" ]]; then
        run apt update
        run apt upgrade
        run pkg upgrade
    fi
}

update_mas() {
    echo "updating mac appstore"
    run mas outdated
    run mas upgrade
}

update_homebrew() {
    echo "Updating HomeBrew"
    run brew update
    run brew upgrade
    echo "updating cask"
    run brew cask upgrade --greedy

    # audit popo to check if it being updated
    brew cask audit popo --download || /usr/bin/true

    run brew cleanup

    _cachedir="$(brew --cache)"
    if [ -d "$_cachedir" ] && [[ "$_cachedir" == "$HOME/Library/Caches/Homebrew" ]]; then
        run rm -rf "$_cachedir"
    fi
}

update_linuxbrew() {
    if [ -d "/home/linuxbrew/.linuxbrew" ] || [ -d "$HOME/.linuxbrew" ]; then
        echo "Updating LinuxBrew"
        run brew update
        run brew upgrade
        run brew cleanup

        _cachedir="$(brew --cache)"
        if [ -d "$_cachedir" ] && [[ "$_cachedir" == "$HOME/.cache/Homebrew" ]]; then
            run rm -rf "$_cachedir"
        fi
    fi
}

update_pip() {
    echo "Updating Pip"
    run pip2 list --format=columns | cut -d ' ' -f 1 | run xargs -n1 pip2 install -U
    run pip3 list --format=columns | cut -d ' ' -f 1 | run xargs -n1 pip3 install -U
}


update_gem() {
    echo "Updating ruby gems"
    if [[ -x "/usr/local/opt/ruby/bin/gem" ]]; then
        run /usr/local/opt/ruby/bin/gem update
    else
        run gem update
    fi
}


update_go() {
    echo "Updating go packages"
    run go get -u all
}


self_update() {
    echo "updating git repo"
    if [ -d "$HOME/dotfiles" ]; then
        cd "$HOME/dotfiles"
        run git pull
        run git submodule update --recursive --remote
        # run git commit -a -m "daily update"
        run git push
    fi
}

update_vim() {
    echo "updating vim"
    cd "$HOME/.vim" && run git pull && run git submodule update --recursive --init
    # TODO not working currectly
    run vim +SPUpdate +qall
}


update_emacs() {
    if [ -f "$HOME/.emacs.d/Makefile" ]; then
        # Doom Emacs
        echo "updating Doom Emacs"
        cd "$HOME/.emacs.d/"
        YES=1 run make upgrade
        YES=1 run make update
        YES=1 run make
        YES=1 run make compile
    else
        # assume it spacemacs
        # TODO not working currectly
        echo "updating spacemacs packages"
        run /usr/local/bin/emacs --no-window-system --load "$HOME/dotfiles/bin/update-emacs.el"
    fi
    for _PROJECT in "$HOME"/emacs-distros/*; do
        if [ -d "${_PROJECT}/.git" ]; then
            cd "${_PROJECT}"
            run git pull
            run git submodule update --remote --recursive
        fi
    done
}


update_optools() {
    echo "updating optools"
    for _DIR in "dumbo" "work"; do
        if [ -d "$HOME/${_DIR}" ]; then
            for _PROJECT in "$HOME"/${_DIR}/*; do
                if [ -d "${_PROJECT}/.git" ]; then
                    cd "${_PROJECT}"
                    run git pull
                    run git submodule update --remote --recursive
                fi
            done
        fi
    done
}

case $OSTYPE in
    linux*)
        self_update
        update_linux_system
        update_linuxbrew
        update_vim
        update_emacs
        ;;
    darwin*)
        self_update
        update_context
        update_mac_system
        update_mas
        update_homebrew
        update_pip
        update_gem
        update_go
        update_vim
        update_emacs
        update_optools
        ;;
    cygwin*)
        echo "unsupported os type $OSTYPE"
        ;;
    *)
        echo "unsupported os type $OSTYPE"
        ;;
esac

