#!/bin/bash -e

cd $HOME

if [[ "$(kextstat | grep "FakeSMC")" == "" ]]; then
    echo "updating system"
    sudo softwareupdate -i -a
fi

echo "Updating HomeBrew"
brew update
brew upgrade
brew cleanup

echo "Updating Pip"
pip2 list --format=legacy | cut -d ' ' -f 1 | xargs -n1 pip2 install -U
pip3 list --format=legacy | cut -d ' ' -f 1 | xargs -n1 pip3 install -U

echo "updating cask"
brew cask upgrade
brew cask cleanup

echo "updating git repo"
if [ -d "$HOME/dotfiles" ]; then
    cd $HOME/dotfiles
    git pull
    git submodule update --recursive --remote
    git commit -a -m "daily update" || /usr/bin/true
    git push || /usr/bin/true
fi

echo "updating vim plugins"
vim +SPUpdate +qall

echo "updating mac appstore"
mas outdated
mas upgrade

echo "updating ConTeXt"
_POSSIBLE_PATH="/Volumes/DATA/ConTeXt /Volumes/MacData/ConTeXt /Volumes/SteamedFish/ConTeXt $HOME/ConTeXt"
for _CONTEXT_PATH in ${_POSSIBLE_PATH}; do
    if [ -d "${_CONTEXT_PATH}" ]; then
        cd ${_CONTEXT_PATH}
        rsync -av rsync://contextgarden.net/minimals/setup/first-setup.sh .
        bash first-setup.sh --modules=all
    fi
done
mtxrun --scripts fonts --reload
unset _POSSIBLE_PATH
unset _CONTEXT_PATH

echo "updating optools"
if [ -d "$HOME/dumbo" ]; then
    for _PROJECT in $(ls "$HOME/dumbo"); do
        if [ -d "$HOME/dumbo/${_PROJECT}/.git" ]; then
            cd "$HOME/dumbo/${_PROJECT}"
            git pull
            git submodule update --remote --recursive
        fi
    done
fi
