#!/bin/bash -e

cd "$HOME"

run() {
    _command="$@"
    if ! $_command ; then
        echo "run $_command failed!" >&2
    fi
}

update_context() {
    echo "updating ConTeXt"
    _POSSIBLE_PATH="/Volumes/DATA/ConTeXt /Volumes/MacData/ConTeXt /Volumes/SteamedFish/ConTeXt $HOME/ConTeXt"
    for _CONTEXT_PATH in ${_POSSIBLE_PATH}; do
        if [ -d "${_CONTEXT_PATH}" ]; then
            cd "${_CONTEXT_PATH}"
            run rsync -av rsync://contextgarden.net/minimals/setup/first-setup.sh .
            run bash first-setup.sh --modules=all
        fi
    done
    run mtxrun --scripts fonts --reload
    unset _POSSIBLE_PATH
    unset _CONTEXT_PATH
}

update_system() {
    if [[ "$(kextstat | grep "FakeSMC")" == "" ]]; then
        echo "updating system"
        run sudo softwareupdate -i -a
    fi
}

update_mas() {
    echo "updating mac appstore"
    run mas outdated
    run mas upgrade
}

update_homebrew() {
    echo "Updating HomeBrew"
    run brew update
    run brew upgrade
    run brew cleanup
    echo "updating cask"
    run brew cask upgrade
    run brew cask cleanup
}

update_pip() {
    echo "Updating Pip"
    pip2 list --format=legacy | cut -d ' ' -f 1 | xargs -n1 pip2 install -U
    pip3 list --format=legacy | cut -d ' ' -f 1 | xargs -n1 pip3 install -U
}


self_update() {
    echo "updating git repo"
    if [ -d "$HOME/dotfiles" ]; then
        cd "$HOME/dotfiles"
        run git pull
        run git submodule update --recursive --remote
        run git commit -a -m "daily update"
        run git push
    fi
}

update_vim() {
    echo "updating vim plugins"
    run vim +SPUpdate +qall
}


update_optools() {
    echo "updating optools"
    if [ -d "$HOME/dumbo" ]; then
        for _PROJECT in "$HOME"/dumbo/*; do
            if [ -d "${_PROJECT}/.git" ]; then
                cd "${_PROJECT}"
                run git pull
                run git submodule update --remote --recursive
            fi
        done
    fi
}

self_update
update_context
update_system
update_mas
update_homebrew
update_pip
update_vim
update_optools
