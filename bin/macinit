#!/bin/bash

pip2_apps=(
cider
pymysql
netaddr
simplejson
pyflakes
pylint
flake8
requests
powerline-status
)

pip3_apps=(
)

mas_apps=(
Numbers
Pixelmator
WeChat
PopClip
Xcode
Pages
iPack
Keynote
iThoughtsX
Tweetbot
)

dirs=(
~/bin
~/.config
~/Library/Rime
~/.ssh
)

# get sudo access
echo "please input sudo password"
sudo /usr/bin/true
while /usr/bin/true; do
    sleep 300
    sudo -n /usr/bin/true
    /bin/kill -0 "$$" 2>/dev/null || exit
done &

# install xcode commandline tools
# if ! [ -d "/Library/Developer/CommandLineTools" ]; then
if ! /usr/sbin/pkgutil --pkg-info com.apple.pkg.CLTools_Executables; then
    echo "install Xcode CommandLine Tools"
    # This file prompts that Command Line Tools should be installed
    sudo /usr/bin/touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
    sudo /usr/sbin/softwareupdate -i $(/usr/sbin/softwareupdate -l | /usr/bin/grep -B 1 -E "Command Line (Developer|Tools)" | /usr/bin/awk -F"*" '/^ +\\*/ {print $2}' | /usr/bin/sed 's/^ *//' | /usr/bin/tail -n1)
    sudo /bin/rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
    sudo /usr/bin/xcode-select --switch /Library/Developer/CommandLineTools
fi

# if ! [ -d "/Library/Developer/CommandLineTools" ]; then
if ! /usr/sbin/pkgutil --pkg-info com.apple.pkg.CLTools_Executables; then
    echo "install Xcode CommandLine Tools failed, Please install it manually"
    sudo /usr/bin/xoode-select --install
    exit 1
fi

# accept Xcode license
sudo xcodebuild -license accept

# install homebrew
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

for apps in ${pip2_apps[@]}; do
    pip2 install $apps
done

for apps in ${pip3_apps[@]}; do
    pip3 install $apps
done

for dir in ${dirs[@]}; do
    mkdir -p $dir
done

# iTerm shell integration
curl -L https://iterm2.com/shell_integration/install_shell_integration_and_utilities.sh | bash

# setup ssh keys before git

git clone git@github.com:SteamedFish/dotfiles.git
cd ~/dotfiles && git submodule update --init --recursive --remote

python ciderrestore.py

for apps in ${mas_apps[@]}; do
    mas install $apps
done

if [[ "$(kextstat | grep "FakeSMC")" != "" ]]; then
    # disable computer sleep
    sudo pmset -a sleep 0
fi

open '/usr/local/Caskroom/lastpass/latest/LastPass Installer/LastPass Installer.app'

# add crontab for NetEase AUTH
echo "* * * * * (/Users/steamedfish/bin/auth 2>&1 >/dev/null)" | crontab
